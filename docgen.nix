inputs @ {
  nixpkgs,
  nix-darwin,
  cli,
  pkgs,
  ...
}: let
  path = "docs";
  warning = "AUTOGENERATED FILE, DO NOT MODIFY MANUALLY";
  inherit (nixpkgs) lib;

  inherit (import ./modules inputs) nixosModules darwinModules;

  flattenOptions = opt:
    if (opt ? "_type" && opt._type == "option")
    then lib.optionalAttrs (!(opt ? "internal" && opt.internal)) {${opt.__toString {}} = opt;} // (flattenOptions (opt.type.getSubOptions opt.loc))
    else lib.foldlAttrs (acc: _: value: acc // (flattenOptions value)) {} opt;

  generateMdOptions = options:
    lib.mapAttrsToList (
      name: value: ''
        <ResponseField
            name="${(value.__toString {})}"
            type="${value.type.description}"
            ${lib.optionalString (value ? "default" && value.default != null) "default={${builtins.toJSON value.default}}"}
            ${lib.optionalString (!value ? "default") "required"}
            >
          ${value.description}
          ${lib.optionalString (value ? "example") ''
          ```nix Example
          ${builtins.toJSON value.example}
          ```
        ''}
        </ResponseField>
      ''
    )
    options;

  nixosSystem = nixpkgs.lib.nixosSystem {
    system = "aarch64-linux";
    modules = nixosModules.default;
  };

  darwinSystem = nix-darwin.lib.darwinSystem {
    system = "aarch64-darwin";
    modules = darwinModules.default;
  };

  allNixosOptions = flattenOptions nixosSystem.options.settings;
  allDarwinOptions = flattenOptions darwinSystem.options.settings;
  commonOptions =
    lib.filterAttrs
    (name: value: (builtins.hasAttr name allNixosOptions) && (builtins.hasAttr name allDarwinOptions))
    (allNixosOptions // allDarwinOptions);

  commonFile = builtins.toFile "common.mdx" ''
    ---
    title: "Common options to NixOS and Darwin"
    sidebarTitle: "Common"
    icon: "share-nodes"
    comment: "${warning}"
    ---
    ${builtins.concatStringsSep "\n" (generateMdOptions commonOptions)}
  '';

  nixosFile = let
    nixosOptions = lib.filterAttrs (name: _: !(builtins.hasAttr name commonOptions)) allNixosOptions;
  in
    builtins.toFile "nixos.mdx" ''
      ---
      title: "NixOS options"
      sidebarTitle: "NixOS"
      icon: "linux"
      comment: "${warning}"
      ---
      ${builtins.concatStringsSep "\n" (generateMdOptions nixosOptions)}
    '';

  darwinFile = let
    darwinOptions = lib.filterAttrs (name: _: !(builtins.hasAttr name commonOptions)) allDarwinOptions;
  in
    builtins.toFile "darwin.mdx" ''
      ---
      title: "Darwin options"
      sidebarTitle: "Darwin"
      icon: "apple"
      comment: "${warning}"
      ---
      ${builtins.concatStringsSep "\n" (generateMdOptions darwinOptions)}
    '';

  hardwareFile = builtins.toFile "hardware.mdx" ''
    ---
    title: "Preconfigured hardware modules"
    sidebarTitle: "Hardware modules"
    icon: "microchip"
    comment: "${warning}"
    ---
    <RequestExample>

    ```nix hosts-nixos/example.nix
    {hardware, ...}: {
      imports = [hardware.hetzner-x86];
    }
    ```

    </RequestExample>
    <ResponseExample>

    ```nix darwin-hosts/example.nix
    {hardware, ...}: {
      imports = [hardware.m1];
    }
    ```

    </ResponseExample>

    | System | Name | Description |
    | ------ | ---- | ----------- |
    ${builtins.concatStringsSep "\n" (lib.mapAttrsToList (name: value: "| Darwin | ${name} | ${value.label} |") (import ./hardware/darwin))}
    ${builtins.concatStringsSep "\n" (lib.mapAttrsToList (name: value: "| NixOS  | ${name} | ${value.label} |") (import ./hardware/nixos))}
  '';

  # TODO ideally, generate cli doc from the click/argparse API: https://click.palletsprojects.com/en/8.1.x/api/#click.HelpFormatter
  commandTemplate = builtins.toFile "command-template.mdx" ''
    {/* ${warning} */}

    ```
    :command:
    ```
  '';
in
  pkgs.writeShellApplication {
    name = "docgen";
    text = let
      sed = "sed -s 's^Usage: nicos^Usage: nix run github:plmercereau/nicos --^g' | sed ':a;N;$!ba;s/\\n/\\\\n/g'";
      #
    in ''
      mkdir -p ${path}/reference
      cp -f ${commonFile} ${path}/reference/machines/common.mdx
      cp -f ${nixosFile} ${path}/reference/machines/nixos.mdx
      cp -f ${darwinFile} ${path}/reference/machines/darwin.mdx
      cp -f ${hardwareFile} ${path}/reference/hardware.mdx
      mkdir -p ${path}/_snippets

      sed -s "s^:command:^$(${cli}/bin/nicos --help | ${sed})^" ${commandTemplate} > ${path}/_snippets/cli.mdx
      sed -s "s^:command:^$(${cli}/bin/nicos build --help | ${sed})^" ${commandTemplate} > ${path}/_snippets/cli-build.mdx
      sed -s "s^:command:^$(${cli}/bin/nicos create --help | ${sed})^" ${commandTemplate} > ${path}/_snippets/cli-create.mdx
      sed -s "s^:command:^$(${cli}/bin/nicos deploy --help | ${sed})^" ${commandTemplate} > ${path}/_snippets/cli-deploy.mdx
      sed -s "s^:command:^$(${cli}/bin/nicos install --help | ${sed})^" ${commandTemplate} > ${path}/_snippets/cli-install.mdx
      sed -s "s^:command:^$(${cli}/bin/nicos secrets --help | ${sed})^" ${commandTemplate} > ${path}/_snippets/cli-secrets.mdx

    '';
  }
